<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - DinhRise Hotel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- AOS Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <!-- Auth Script -->
    <script src="/js/auth.js"></script>
    <style>
        .sidebar {
            transition: all 0.3s ease;
        }
        .sidebar.collapsed {
            width: 80px;
        }
        .sidebar.collapsed .sidebar-text {
            display: none;
        }
        .main-content {
            transition: all 0.3s ease;
        }
        .main-content.expanded {
            margin-left: 80px;
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #EF4444;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Sidebar -->
    <div class="sidebar fixed h-screen bg-white shadow-lg w-64" id="sidebar">
        <div class="p-4">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center">
                    <img src="https://cdn-icons-png.flaticon.com/512/2111/2111320.png" alt="Hotel Logo" class="h-8 w-auto">
                    <span class="ml-2 text-xl font-bold text-gray-800 sidebar-text">DinhRise Hotel</span>
                </div>
                <button id="toggleSidebar" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <div class="space-y-2">
                <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100 active">
                    <i class="fas fa-home w-6"></i>
                    <span class="ml-3 sidebar-text">Dashboard</span>
                </a>
                <a href="/account-management.html" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-user-shield w-6"></i>
                    <span class="ml-3 sidebar-text">Account Authorization</span>
                </a>
                <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-users w-6"></i>
                    <span class="ml-3 sidebar-text">Employee Management</span>
                </a>
                <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-bed w-6"></i>
                    <span class="ml-3 sidebar-text">Room Management</span>
                </a>
                <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-concierge-bell w-6"></i>
                    <span class="ml-3 sidebar-text">Service Management</span>
                </a>
                <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-chart-line w-6"></i>
                    <span class="ml-3 sidebar-text">Reports & Analytics</span>
                </a>
                <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-cog w-6"></i>
                    <span class="ml-3 sidebar-text">Settings</span>
                </a>
                <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-bell w-6"></i>
                    <span class="ml-3 sidebar-text">Notifications</span>
                    <span class="notification-badge">3</span>
                </a>
                <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-user w-6"></i>
                    <span class="ml-3 sidebar-text">Profile</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content ml-64 p-8" id="mainContent">
        <!-- Top Navigation -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <button id="userMenuButton" class="flex items-center space-x-3 bg-white px-4 py-2 rounded-lg shadow-sm hover:bg-gray-50 transition-all duration-200">
                        <i class="fas fa-user-circle text-2xl text-gray-600"></i>
                        <span id="usernameDisplay" class="font-medium text-gray-700">Loading...</span>
                        <i class="fas fa-chevron-down text-gray-500 text-sm"></i>
                    </button>
                    <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-1 z-50 border border-gray-100">
                        <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                            <i class="fas fa-user-circle mr-2"></i>
                            Profile
                        </a>
                        <a href="#" onclick="logout()" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                            <i class="fas fa-sign-out-alt mr-2"></i>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg shadow-md p-6 transform transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-indigo-700 text-sm font-medium">Total Employees</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="totalEmployeesCount">--</h3>
                    </div>
                    <div class="bg-indigo-200 p-3 rounded-full">
                        <i class="fas fa-user-tie text-indigo-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-indigo-600 text-sm">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span>All staff members</span>
                </div>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow-md p-6 transform transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-700 text-sm font-medium">Total Rooms</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="totalRoomsCount">--</h3>
                    </div>
                    <div class="bg-blue-200 p-3 rounded-full">
                        <i class="fas fa-bed text-blue-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-blue-600 text-sm">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span>Available accommodation</span>
                </div>
            </div>
            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-md p-6 transform transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-700 text-sm font-medium">Today's Bookings</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="todayBookingsCount">--</h3>
                    </div>
                    <div class="bg-green-200 p-3 rounded-full">
                        <i class="fas fa-calendar-check text-green-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-green-600 text-sm">
                    <i class="fas fa-sync mr-1"></i>
                    <span>Updated daily</span>
                </div>
            </div>
            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg shadow-md p-6 transform transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-yellow-700 text-sm font-medium">Today's Revenue</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="todayRevenueCount">--</h3>
                    </div>
                    <div class="bg-yellow-200 p-3 rounded-full">
                        <i class="fas fa-money-bill-wave text-yellow-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-yellow-600 text-sm">
                    <i class="fas fa-sync mr-1"></i>
                    <span>Updated daily</span>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <!-- Revenue Chart -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Revenue Overview</h2>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!-- Occupancy Chart -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Room Occupancy</h2>
                <div class="chart-container">
                    <canvas id="occupancyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Utility function to format date to YYYY-MM-DD
        function formatDateToYYYYMMDD(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Utility function to format currency (VND)
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Document ready function - entry point
        $(document).ready(function() {
            // Check if admin is logged in
            if (!checkAdminAuthentication()) {
                window.location.href = 'login.html';
                return;
            }

            // Initialize animations
            AOS.init();
            
            // Load initial dashboard data
            loadDashboardData();
            
            // Setup automatic refresh
            setupDailyRefresh();
            setupChartRefresh();

            // Setup click outside to close profile menu
            $(document).click(function(event) {
                if (!$(event.target).closest('#userMenuButton, #userMenu').length) {
                    $('#userMenu').addClass('hidden');
                }
            });
        });

        // Function to load all dashboard data
        function loadDashboardData() {
            loadEmployeeCount();
            loadRoomCount();
            loadTodayBookings();
            loadTodayRevenue();
            initializeCharts();
        }

        // Load employee count
        function loadEmployeeCount() {
            const token = localStorage.getItem('token');
            if (!token) {
                $('#totalEmployeesCount').text('Auth Error');
                return;
            }
            
            fetch('https://localhost:8443/admin/count-employees', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch employee count: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.result !== undefined) {
                    $('#totalEmployeesCount').text(data.result);
                }
            })
            .catch(error => {
                console.error('Error fetching employee count:', error);
                $('#totalEmployeesCount').text('Error');
            });
        }

        // Load room count
        function loadRoomCount() {
            const token = localStorage.getItem('token');
            if (!token) {
                $('#totalRoomsCount').text('Auth Error');
                return;
            }
            
            fetch('https://localhost:8443/admin/count-rooms', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch room count: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.result !== undefined) {
                    $('#totalRoomsCount').text(data.result);
                }
            })
            .catch(error => {
                console.error('Error fetching room count:', error);
                $('#totalRoomsCount').text('Error');
            });
        }

        // Load today's bookings with current date
        function loadTodayBookings() {
            const token = localStorage.getItem('token');
            if (!token) {
                $('#todayBookingsCount').text('Auth Error');
                return;
            }
            
            const today = formatDateToYYYYMMDD(new Date());
            
            fetch(`https://localhost:8443/admin/today-bookings?date=${today}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch today bookings: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.result !== undefined) {
                    $('#todayBookingsCount').text(data.result);
                }
            })
            .catch(error => {
                console.error('Error fetching today bookings:', error);
                $('#todayBookingsCount').text('Error');
            });
        }

        // Load today's revenue with current date
        function loadTodayRevenue() {
            const token = localStorage.getItem('token');
            if (!token) {
                $('#todayRevenueCount').text('Auth Error');
                return;
            }
            
            const today = formatDateToYYYYMMDD(new Date());
            
            // Try POST method with date in body
            fetch('https://localhost:8443/admin/today-revenue', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ now: today })
            })
            .then(response => {
                if (!response.ok) {
                    // Fallback to GET if POST fails
                    return tryGetTodayRevenue();
                }
                return response.json();
            })
            .then(data => {
                if (data && data.result !== undefined) {
                    $('#todayRevenueCount').text(formatCurrency(data.result));
                }
            })
            .catch(error => {
                console.error('Error fetching today revenue:', error);
                $('#todayRevenueCount').text('Error');
            });
        }
        
        // Fallback GET method for today's revenue
        function tryGetTodayRevenue() {
            const token = localStorage.getItem('token');
            if (!token) return Promise.reject('No token');
            
            const today = formatDateToYYYYMMDD(new Date());
            
            return fetch(`https://localhost:8443/admin/today-revenue?now=${today}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('GET method failed: ' + response.status);
                }
                return response.json();
            });
        }

        // Initialize AOS
        AOS.init({
            duration: 1000,
            once: true
        });

        // Toggle sidebar
        $('#toggleSidebar').click(function() {
            $('#sidebar').toggleClass('collapsed');
            $('#mainContent').toggleClass('expanded');
        });

        // Toggle user menu
        $('#userMenuButton').click(function() {
            $('#userMenu').toggleClass('hidden');
        });

        // Initialize charts
        function initializeCharts() {
            // Get the current date to determine the default year and month range
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            
            // Create revenue chart (will be updated with API data)
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            const revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Revenue',
                        data: [],
                        borderColor: '#4F46E5',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // Load revenue data from API
            loadRevenueData(revenueChart, currentYear, 1, 6);

            // Create Occupancy Chart (will be updated with API data)
            const occupancyCtx = document.getElementById('occupancyChart').getContext('2d');
            const occupancyChart = new Chart(occupancyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Occupancy Rate (%)',
                        data: [],
                        backgroundColor: '#10B981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            // Load occupancy data from API
            loadOccupancyData(occupancyChart);
        }
        
        // Load revenue data from API
        function loadRevenueData(chart, year, startMonth, endMonth) {
            const token = localStorage.getItem('token');
            if (!token) {
                chart.data.labels = ['Auth Error'];
                chart.data.datasets[0].data = [0];
                chart.update();
                return;
            }
            
            // Show loading state in chart
            chart.data.labels = ['Loading...'];
            chart.data.datasets[0].data = [0];
            chart.update();
            
            // Call the revenue API
            fetch(`https://localhost:8443/admin/revenue?year=${year}&startMonth=${startMonth}&endMonth=${endMonth}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load revenue data');
                }
                return response.json();
            })
            .then(data => {
                if (data && data.result) {
                    const revenueData = data.result;
                    const labels = Object.keys(revenueData);
                    const values = Object.values(revenueData);
                    
                    // Update chart with real data
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = values;
                    chart.update();
                }
            })
            .catch(error => {
                console.error('Error loading revenue data:', error);
                chart.data.labels = ['Error'];
                chart.data.datasets[0].data = [0];
                chart.update();
            });
        }

        // Load occupancy data from API
        function loadOccupancyData(chart) {
            const token = localStorage.getItem('token');
            if (!token) {
                chart.data.labels = ['Auth Error'];
                chart.data.datasets[0].data = [0];
                chart.update();
                return;
            }
            
            // Show loading state in chart
            chart.data.labels = ['Loading...'];
            chart.data.datasets[0].data = [0];
            chart.update();
            
            // Call the occupancy API
            fetch('https://localhost:8443/admin/room-occupancy', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load occupancy data');
                }
                return response.json();
            })
            .then(data => {
                if (data && data.result) {
                    const occupancyData = data.result;
                    const labels = Object.keys(occupancyData);
                    const values = Object.values(occupancyData);
                    
                    // Update chart with real data
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = values;
                    chart.update();
                }
            })
            .catch(error => {
                console.error('Error loading occupancy data:', error);
                chart.data.labels = ['Error'];
                chart.data.datasets[0].data = [0];
                chart.update();
            });
        }

        // Check admin authentication
        function checkAdminAuthentication() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                // Redirect to login if token doesn't exist
                window.location.href = 'login.html';
                return false;
            }
            
            try {
                // Decode JWT token to check admin role
                const tokenParts = token.split('.');
                if (tokenParts.length !== 3) {
                    throw new Error('Invalid token format');
                }
                
                const payload = JSON.parse(atob(tokenParts[1]));
                
                // Check if token has admin role (scope field)
                if (!payload.scope || payload.scope !== 'ROLE_ADMIN') {
                    // Redirect if not admin
                    window.location.href = 'login.html';
                    return false;
                }
                
                // Set admin username in header from token
                $('#usernameDisplay').text(payload.sub || 'Admin');
                
                return true;
            } catch (error) {
                console.error('Error validating admin token:', error);
                // Redirect to login if token is invalid
                window.location.href = 'login.html';
                return false;
            }
        }

        // Setup daily refresh to update statistics
        function setupDailyRefresh() {
            // Calculate time until next day (midnight)
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const timeUntilMidnight = tomorrow - now;
            
            // Schedule refresh at midnight
            setTimeout(() => {
                loadDashboardData();
                // After first execution, set up a daily interval
                setInterval(loadDashboardData, 24 * 60 * 60 * 1000);
            }, timeUntilMidnight);
            
            console.log(`Dashboard will refresh in ${Math.floor(timeUntilMidnight / 60000)} minutes at midnight`);
        }

        // Setup chart refresh (every hour)
        function setupChartRefresh() {
            // Update charts every hour
            setInterval(() => {
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                
                // Reinitialize charts with fresh data
                const revenueChart = Chart.getChart('revenueChart');
                const occupancyChart = Chart.getChart('occupancyChart');
                
                if (revenueChart) {
                    loadRevenueData(revenueChart, currentYear, 1, 12);
                }
                
                if (occupancyChart) {
                    loadOccupancyData(occupancyChart);
                }
            }, 60 * 60 * 1000); // Every hour
        }

        // Helper functions
        function getActivityIcon(type) {
            switch(type) {
                case 'EMPLOYEE':
                    return 'fa-user';
                case 'BOOKING':
                    return 'fa-calendar-check';
                case 'ROOM':
                    return 'fa-bed';
                case 'SERVICE':
                    return 'fa-concierge-bell';
                default:
                    return 'fa-bell';
            }
        }

        function getActivityColor(type) {
            switch(type) {
                case 'EMPLOYEE':
                    return 'blue';
                case 'BOOKING':
                    return 'green';
                case 'ROOM':
                    return 'yellow';
                case 'SERVICE':
                    return 'purple';
                default:
                    return 'gray';
            }
        }

        function getNotificationIcon(type) {
            switch(type) {
                case 'SYSTEM':
                    return 'fa-server';
                case 'ALERT':
                    return 'fa-exclamation-circle';
                case 'UPDATE':
                    return 'fa-sync';
                default:
                    return 'fa-bell';
            }
        }

        function getNotificationColor(type) {
            switch(type) {
                case 'SYSTEM':
                    return 'blue';
                case 'ALERT':
                    return 'red';
                case 'UPDATE':
                    return 'yellow';
                default:
                    return 'gray';
            }
        }

        // Function to set loading state for stats cards
        function setLoadingState(elementId, isLoading) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (isLoading) {
                element.innerHTML = `
                    <div class="flex justify-center items-center h-full">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                    </div>
                `;
            } else {
                // Reset the loading state if needed
            }
        }
    </script>
</body>
</html>