<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings - DinhRise Hotel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- AOS Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Xác thực cơ bản -->
    <script>
    // Hàm đọc cookie bằng tên
    function getCookie(name) {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        if (match) return match[2];
        
        // Nếu là user_role, role hoặc scope và không tìm thấy trong cookie, thử lấy từ localStorage
        if ((name === 'user_role' || name === 'role' || name === 'scope') && !match) {
            try {
                const localRole = localStorage.getItem('user_role');
                if (localRole) {
                    console.log('Role not found in cookie, using from localStorage');
                    // Thử thiết lập lại cookie từ localStorage
                    setCookie('user_role', localRole);
                    return localRole;
                }
            } catch (e) {
                console.log('Error accessing localStorage:', e);
            }
        }
        
        return null;
    }

    // Hàm đăng xuất
    function logout() {
        // Xóa cookie với các domain và path khác nhau để đảm bảo xóa hết
        const cookiesToClear = ["token", "user_role", "role", "scope", "userId"];
        const domains = ["", "localhost", ".localhost", window.location.hostname];
        const paths = ["/", "", "/customer-dashboard.html", "/my-bookings.html"];
        
        cookiesToClear.forEach(cookieName => {
            // Xóa với tất cả các domain và path có thể
            domains.forEach(domain => {
                paths.forEach(path => {
                    // Xóa cookie với domain
                    if (domain) {
                        document.cookie = `${cookieName}=; domain=${domain}; path=${path}; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax`;
                    }
                    // Xóa cookie không có domain
                    document.cookie = `${cookieName}=; path=${path}; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax`;
                });
            });
        });
        
        // Xóa cả dữ liệu trong localStorage
        try {
            localStorage.removeItem('user_role');
            localStorage.removeItem('token'); // Xóa cả token nếu có
            console.log('Cleared localStorage authentication data');
        } catch (e) {
            console.log('Error clearing localStorage:', e);
        }
        
        console.log('Logged out and cleared cookies');
        window.location.href = '/login.html?logged_out=true';
    }

    // Hàm kiểm tra trạng thái đăng nhập
    function checkLoginStatus() {
        const token = getCookie('token');
        const userRole = getCookie('user_role') || getCookie('role') || getCookie('scope');
        console.log('Checking login status - Token:', token);
        console.log('Checking login status - Role:', userRole);
        console.log('All cookies:', document.cookie);
        
        // Nếu không có token, kiểm tra xem có role từ localStorage không
        if (!token) {
            console.log('No token found in cookie, checking if we have role in localStorage');
            
            try {
                const localRole = localStorage.getItem('user_role');
                if (localRole) {
                    console.log('Found role in localStorage:', localRole);
                    // Nếu có role trong localStorage, chuyển hướng về login để lấy token mới
                    window.location.href = '/login.html?session_expired=true';
                    return false;
                }
            } catch (e) {
                console.log('Error accessing localStorage:', e);
            }
            
            // Nếu không có cả token và role, chuyển hướng về login
            if (!userRole) {
                console.log('No valid token or role found, redirecting to login');
                window.location.href = '/login.html?session_expired=true';
                return false;
            }
        }
        return true;
    }

    // Thiết lập cookie bảo mật
    function setCookie(name, value, expiryDays = 7) {
        const date = new Date();
        date.setTime(date.getTime() + (expiryDays * 24 * 60 * 60 * 1000));
        const expires = "expires=" + date.toUTCString();
        document.cookie = name + "=" + value + "; " + expires + "; path=/; SameSite=Lax";
        console.log('Set cookie:', name, 'with value:', value, 'expires in', expiryDays, 'days');
    }

    // Đảm bảo AJAX gửi kèm cookie
    $.ajaxSetup({
        xhrFields: {
            withCredentials: true
        }
    });

    // Kiểm tra trạng thái đăng nhập khi trang tải
    $(document).ready(function() {
        checkLoginStatus();
        
        // Lấy token từ cookie, không dùng localStorage nữa
        const token = getCookie('token');
        console.log('Token available:', !!token);
        
        if (token) {
            loadBookings();
            
            // Add event handler for user menu button
            $('#userMenuButton').click(function() {
                const userMenu = $('#userMenu');
                userMenu.toggleClass('hidden');
                
                if (!userMenu.hasClass('hidden')) {
                    userMenu.removeClass('scale-95 opacity-0');
                    userMenu.addClass('scale-100 opacity-100');
                } else {
                    userMenu.removeClass('scale-100 opacity-100');
                    userMenu.addClass('scale-95 opacity-0');
                }
            });
            
            // Close menu when clicking outside
            $(document).on('click', function(event) {
                if (!$(event.target).closest('#userMenuButton, #userMenu').length) {
                    $('#userMenu').addClass('hidden');
                }
            });
            
            // Handle scroll for nav bar
            $(window).scroll(function() {
                if ($(window).scrollTop() > 50) {
                    $('#navContainer').addClass('shrink');
                    $('.nav-logo').addClass('transform scale-75');
                    $('.nav-text').addClass('text-indigo-800');
                    $('.nav-link').removeClass('text-white').addClass('text-gray-800');
                } else {
                    $('#navContainer').removeClass('shrink');
                    $('.nav-logo').removeClass('transform scale-75');
                    $('.nav-text').removeClass('text-indigo-800').addClass('text-white');
                    $('.nav-link').removeClass('text-gray-800').addClass('text-white');
                }
            });
        }
    });
    </script>
    <style>
        body {
            background-color: #F8FAFC;
        }

        .hero-section {
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1566073771259-6a8506099945?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-size: cover;
            background-position: center;
            height: 400px;
            position: relative;
            overflow: hidden;
        }

        .nav-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .nav-container.shrink {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .booking-card {
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .booking-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: #FEF3C7;
            color: #92400E;
        }

        .status-confirmed {
            background-color: #D1FAE5;
            color: #065F46;
        }

        .status-cancelled {
            background-color: #FEE2E2;
            color: #991B1B;
        }

        .btn-pay {
            background: linear-gradient(to right, #4F46E5, #7C3AED);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-pay:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        }

        .btn-pay:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: #4F46E5;
            color: white;
        }

        /* Add styles for the modal */
        .booking-details-modal .swal2-popup {
            padding: 2rem;
            animation: modalFadeIn 0.3s ease-out;
            background: linear-gradient(to bottom right, #ffffff, #f8fafc);
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90vw;
            width: 900px;
            margin: 2rem auto;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes modalFadeOut {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            to {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
        }

        .booking-details-modal .swal2-close {
            transition: all 0.3s ease;
            color: #4F46E5;
            font-size: 1.5rem;
            right: 1.5rem;
            top: 1.5rem;
            position: absolute;
            z-index: 100;
        }

        .booking-details-modal .swal2-close:hover {
            transform: rotate(90deg);
            color: #4338CA;
        }

        .booking-details-modal .grid {
            gap: 1.5rem;
        }

        .booking-details-modal .p-3 {
            padding: 1.25rem;
            transition: all 0.3s ease;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 0.75rem;
        }

        .booking-details-modal .mb-4 {
            margin-bottom: 2rem;
        }

        .booking-details-modal .space-y-2 > * + * {
            margin-top: 1rem;
        }

        .booking-details-modal .text-lg {
            font-size: 1.25rem;
            color: #1F2937;
        }

        .booking-details-modal .text-xl {
            font-size: 1.5rem;
        }

        .booking-details-modal .p-4 {
            padding: 1.5rem;
            background: linear-gradient(135deg, #EEF2FF, #E0E7FF);
            border-radius: 1rem;
        }

        /* Hover effects */
        .booking-details-modal .p-3:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #C7D2FE;
        }

        /* Icon animations */
        .booking-details-modal .fas {
            transition: all 0.3s ease;
        }

        .booking-details-modal .p-3:hover .fas {
            transform: scale(1.2);
            color: #4F46E5;
        }

        /* Custom scrollbar */
        .booking-details-modal .swal2-popup::-webkit-scrollbar {
            width: 6px;
        }

        .booking-details-modal .swal2-popup::-webkit-scrollbar-track {
            background: #F3F4F6;
            border-radius: 3px;
        }

        .booking-details-modal .swal2-popup::-webkit-scrollbar-thumb {
            background: #C7D2FE;
            border-radius: 3px;
        }

        .booking-details-modal .swal2-popup::-webkit-scrollbar-thumb:hover {
            background: #818CF8;
        }

        /* Title styling */
        .booking-details-modal .swal2-title {
            color: #1F2937;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding: 0 2rem;
        }

        /* Text colors */
        .booking-details-modal .text-gray-600 {
            color: #4B5563;
        }

        .booking-details-modal .text-indigo-600 {
            color: #4F46E5;
        }

        .booking-details-modal .text-indigo-900 {
            color: #312E81;
        }

        /* Font weights */
        .booking-details-modal .font-semibold {
            font-weight: 600;
        }

        .booking-details-modal .font-bold {
            font-weight: 700;
        }

        /* Modal backdrop */
        .swal2-backdrop-show {
            background: rgba(0, 0, 0, 0.5) !important;
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <div class="hero-section flex items-center justify-center text-white">
        <div class="hero-content text-center">
            <h1 class="text-5xl font-bold mb-6" data-aos="fade-up">My Bookings</h1>
            <p class="text-xl mb-8" data-aos="fade-up" data-aos-delay="100">View and manage your hotel bookings</p>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-container" id="navContainer">
        <nav class="bg-transparent">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between h-20">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <img src="https://cdn-icons-png.flaticon.com/512/2111/2111320.png" alt="Hotel Logo" class="h-12 w-auto nav-logo transition-transform duration-300">
                            <span class="ml-2 text-2xl font-bold text-white nav-text transition-all duration-300">DinhRise Hotel</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/customer-dashboard.html" class="nav-link text-white hover:text-gray-200 px-4 py-2 rounded-md text-base font-medium">
                            <i class="fas fa-home mr-1"></i> Main Menu
                        </a>
                        <a href="/book-room.html" class="nav-link text-white hover:text-gray-200 px-4 py-2 rounded-md text-base font-medium">
                            <i class="fas fa-calendar-plus mr-1"></i> New Booking
                        </a>
                        <div class="relative ml-3">
                            <button type="button" id="userMenuButton"
                                class="flex items-center space-x-2 text-white hover:text-indigo-200 transition-colors duration-200">
                                <img id="userAvatar" class="w-8 h-8 rounded-full border-2 border-white hover:scale-105 transition-transform duration-200"
                                    src="https://ui-avatars.com/api/?name=User&background=4F46E5&color=fff"
                                    alt="">
                            </button>

                            <!-- Profile dropdown -->
                            <div id="userMenu"
                                class="hidden absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-2xl border border-gray-100 overflow-hidden transform transition-all duration-300 origin-top-right scale-95 opacity-0"
                                role="menu" aria-orientation="vertical" aria-labelledby="userMenuButton" tabindex="-1">
                                <div class="p-4">
                                    <!-- Profile Information -->
                                    <div class="flex items-center space-x-3 mb-4 p-3 bg-indigo-50 rounded-lg">
                                        <img id="userMenuAvatar" class="w-12 h-12 rounded-full border-2 border-indigo-500 shadow-md"
                                            src="https://ui-avatars.com/api/?name=User&background=4F46E5&color=fff"
                                            alt="">
                                        <div>
                                            <h3 id="userMenuName" class="text-lg font-bold text-gray-900">Michael Man</h3>
                                            <span class="text-sm text-indigo-600 font-medium">Standard Member</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Personal Information -->
                                    <div class="space-y-3">
                                        <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider flex items-center">
                                            <svg class="w-4 h-4 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                            </svg>
                                            Personal Information
                                        </h4>
                                        <div id="userMenuEmail" class="flex items-center space-x-2 text-gray-700 p-2 hover:bg-indigo-50 rounded-lg transition-all duration-200 group">
                                            <div class="w-8 h-8 flex items-center justify-center bg-indigo-100 rounded-full group-hover:bg-indigo-200 transition-colors duration-200">
                                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                                </svg>
                                            </div>
                                            <span class="group-hover:text-indigo-600 transition-colors duration-200">microb@example.com</span>
                                        </div>
                                        <div id="userMenuPhone" class="flex items-center space-x-2 text-gray-700 p-2 hover:bg-indigo-50 rounded-lg transition-all duration-200 group">
                                            <div class="w-8 h-8 flex items-center justify-center bg-indigo-100 rounded-full group-hover:bg-indigo-200 transition-colors duration-200">
                                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                                </svg>
                                            </div>
                                            <span class="group-hover:text-indigo-600 transition-colors duration-200">092236789</span>
                                        </div>
                                        <div id="userMenuAddress" class="flex items-center space-x-2 text-gray-700 p-2 hover:bg-indigo-50 rounded-lg transition-all duration-200 group">
                                            <div class="w-8 h-8 flex items-center justify-center bg-indigo-100 rounded-full group-hover:bg-indigo-200 transition-colors duration-200">
                                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                </svg>
                                            </div>
                                            <span class="group-hover:text-indigo-600 transition-colors duration-200">Hanoi</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Account Settings -->
                                    <div class="mt-4 pt-4 border-t border-gray-100">
                                        <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3 flex items-center">
                                            <svg class="w-4 h-4 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            </svg>
                                            Account Settings
                                        </h4>
                                        <div class="space-y-2">
                                            <a href="/profile-edit.html" class="flex items-center space-x-2 text-gray-700 p-2 hover:bg-indigo-50 rounded-lg transition-colors duration-200">
                                                <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                                </svg>
                                                <span>Edit Profile</span>
                                            </a>
                                            <button onclick="logout()" class="flex items-center space-x-2 text-gray-700 p-2 hover:bg-red-50 rounded-lg transition-colors duration-200 w-full">
                                                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                                </svg>
                                                <span>Logout</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-12">
        <div class="grid grid-cols-1 gap-8">
            <!-- Bookings List -->
            <div id="bookingsList" class="space-y-6">
                <!-- Bookings will be loaded here -->
            </div>

            <!-- Pagination -->
            <div class="flex justify-center items-center space-x-4 mt-8">
                <button id="prevPage" class="pagination-btn bg-gray-100 text-gray-700" disabled>
                    <i class="fas fa-chevron-left mr-2"></i> Previous
                </button>
                <span id="pageInfo" class="text-gray-600">Page 1 of 1</span>
                <button id="nextPage" class="pagination-btn bg-gray-100 text-gray-700" disabled>
                    Next <i class="fas fa-chevron-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize AOS
        AOS.init({
            duration: 1000,
            once: true
        });

        // Handle header shrink on scroll
        $(window).scroll(function() {
            if ($(window).scrollTop() > 50) {
                $('#navContainer').addClass('shrink');
                $('.nav-link').css('color', '#374151');
                $('.nav-link:hover').css('color', '#4F46E5');
                $('#userMenuButton').css('color', '#374151');
                $('#userMenuButton:hover').css('color', '#4F46E5');
                $('.nav-text').css('color', '#374151');
            } else {
                $('#navContainer').removeClass('shrink');
                $('.nav-link').css('color', 'white');
                $('.nav-link:hover').css('color', '#E5E7EB');
                $('#userMenuButton').css('color', 'white');
                $('#userMenuButton:hover').css('color', '#E5E7EB');
                $('.nav-text').css('color', 'white');
            }
        });

        // Check authentication
        $(document).ready(function() {
            checkLoginStatus();
            
            // Lấy token từ cookie, không dùng localStorage nữa
            const token = getCookie('token');
            console.log('Token available:', !!token);
            
            if (token) {
                loadBookings();
                
                // Add event handler for user menu button
                $('#userMenuButton').click(function() {
                    const userMenu = $('#userMenu');
                    userMenu.toggleClass('hidden');
                    
                    if (!userMenu.hasClass('hidden')) {
                        userMenu.removeClass('scale-95 opacity-0');
                        userMenu.addClass('scale-100 opacity-100');
                    } else {
                        userMenu.removeClass('scale-100 opacity-100');
                        userMenu.addClass('scale-95 opacity-0');
                    }
                });
                
                // Close menu when clicking outside
                $(document).on('click', function(event) {
                    if (!$(event.target).closest('#userMenuButton, #userMenu').length) {
                        $('#userMenu').addClass('hidden');
                    }
                });
                
                // Handle scroll for nav bar
                $(window).scroll(function() {
                    if ($(window).scrollTop() > 50) {
                        $('#navContainer').addClass('shrink');
                        $('.nav-logo').addClass('transform scale-75');
                        $('.nav-text').addClass('text-indigo-800');
                        $('.nav-link').removeClass('text-white').addClass('text-gray-800');
                    } else {
                        $('#navContainer').removeClass('shrink');
                        $('.nav-logo').removeClass('transform scale-75');
                        $('.nav-text').removeClass('text-indigo-800').addClass('text-white');
                        $('.nav-link').removeClass('text-gray-800').addClass('text-white');
                    }
                });
            }
        });

        // Pagination variables
        let currentPage = 0;
        let totalPages = 1;
        const pageSize = 10;

        // Load bookings
        function loadBookings() {
            ajaxWithAuth({
                url: '/booking/my-bookings',
                method: 'GET',
                success: function(response) {
                    console.log('Bookings response:', response);
                    if (response && response.result) {
                        const pageData = response.result;
                        const bookings = pageData.content || [];
                        totalPages = pageData.totalPages || 1;

                        displayBookings(bookings);
                        updatePaginationUI();
                    } else {
                        $('#bookingsList').html('<p class="text-center text-gray-500">No bookings found</p>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading bookings:', {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseText: xhr.responseText,
                        error: error
                    });
                    
                    if (xhr.status === 401) {
                        // Token expired or invalid
                        window.location.href = '/login.html?session_expired=true';
                    } else if (xhr.status === 500) {
                        // Server error
                        $('#bookingsList').html(`
                            <div class="text-center p-4 bg-red-50 rounded-lg">
                                <p class="text-red-600 font-medium">Server error occurred</p>
                                <p class="text-gray-600 mt-2">Please try again later or contact support if the problem persists.</p>
                            </div>
                        `);
                    } else {
                        $('#bookingsList').html(`
                            <div class="text-center p-4 bg-red-50 rounded-lg">
                                <p class="text-red-600 font-medium">Error loading bookings</p>
                                <p class="text-gray-600 mt-2">Please try again later.</p>
                            </div>
                        `);
                    }
                }
            });
        }

        // Display bookings
        function displayBookings(bookings) {
            const bookingsList = $('#bookingsList');
            bookingsList.empty();

            if (!bookings || bookings.length === 0) {
                bookingsList.html('<p class="text-gray-500 text-center py-8">No bookings found.</p>');
                return;
            }

            bookings.forEach(booking => {
                // Ensure booking status and payment status exist and convert to lowercase, or use default values
                const bookingStatus = (booking.bookingStatus || 'PENDING').toLowerCase();
                const paymentStatus = (booking.paymentStatus || 'PENDING').toLowerCase();
                
                // Debug: Log status values
                console.log('Booking #' + booking.bookingId + ' - bookingStatus:', bookingStatus, '- paymentStatus:', paymentStatus);

                // Get appropriate status colors
                const bookingStatusColor = getStatusColor(bookingStatus);
                const paymentStatusColor = getStatusColor(paymentStatus);

                const formattedDate = formatDate(booking.bookingDate);
                const formattedRoomPrice = formatCurrency(booking.totalRoomPrice);
                const formattedServicePrice = formatCurrency(booking.totalBookingServicePrice);
                const formattedGrandTotal = formatCurrency(booking.grandTotal);

                // Show Cancel button when booking is not cancelled or completed
                const showCancelButton = bookingStatus !== 'cancelled' && bookingStatus !== 'completed';
                
                // Show Create Bill button only when booking is in PENDING status
                const showCreateBillButton = bookingStatus === 'pending';

                // Show Display Booking button when booking is CONFIRMED
                const showDisplayButton = bookingStatus === 'confirmed';

                const bookingHtml = `
                    <div class="bg-white rounded-lg shadow-md p-6 mb-4 hover:shadow-lg transition-shadow duration-200">
                        <div class="flex flex-wrap justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Đơn đặt #${booking.bookingId}</h3>
                                <p class="text-sm text-gray-500">Ngày đặt: ${new Date(booking.bookingDate).toLocaleDateString('vi-VN')}</p>
                                <p class="text-sm text-gray-500">Trạng thái: ${booking.bookingStatus}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold text-gray-900">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(booking.grandTotal)}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-gray-600">Room Total:</p>
                                <p class="text-lg font-semibold">${formattedRoomPrice}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Services Total:</p>
                                <p class="text-lg font-semibold">${formattedServicePrice}</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-4 border-t">
                            <div>
                                <p class="text-gray-600">Grand Total:</p>
                                <p class="text-xl font-bold text-indigo-600">${formattedGrandTotal}</p>
                            </div>
                            <div class="flex space-x-2">
                                ${showCreateBillButton ? `
                                    <button onclick="createBill('${booking.bookingId}')" 
                                            class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors duration-200 flex items-center space-x-2">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                        <span>Create Bill</span>
                                    </button>
                                ` : ''}
                                ${showDisplayButton ? `
                                    <button onclick="displayBookingDetails('${booking.bookingId}')" 
                                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors duration-200 flex items-center space-x-2">
                                        <i class="fas fa-info-circle"></i>
                                        <span>Display Booking</span>
                                    </button>
                                ` : ''}
                                ${showCancelButton ? `
                                    <button onclick="cancelBookingWithConfirmation('${booking.bookingId}')" 
                                            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200 flex items-center space-x-2">
                                        <i class="fas fa-times"></i>
                                        <span>Cancel</span>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                bookingsList.append(bookingHtml);
            });
        }

        function getStatusColor(status) {
            const statusColors = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'confirmed': 'bg-green-100 text-green-800',
                'cancelled': 'bg-red-100 text-red-800',
                'completed': 'bg-blue-100 text-blue-800',
                'paid': 'bg-green-100 text-green-800',
                'unpaid': 'bg-red-100 text-red-800'
            };
            return statusColors[status] || 'bg-gray-100 text-gray-800';
        }

        function capitalizeFirstLetter(string) {
            if (!string) return 'Unknown';
            return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount);
        }

        // Update pagination UI
        function updatePaginationUI() {
            $('#pageInfo').text(`Page ${currentPage + 1} of ${totalPages}`);
            $('#prevPage').prop('disabled', currentPage === 0);
            $('#nextPage').prop('disabled', currentPage === totalPages - 1);
        }

        // Handle pagination
        $('#prevPage').click(function() {
            if (currentPage > 0) {
                currentPage--;
                loadBookings();
            }
        });

        $('#nextPage').click(function() {
            if (currentPage < totalPages - 1) {
                currentPage++;
                loadBookings();
            }
        });

        // Add a new function to update the profile menu
        function updateProfileMenu(userData) {
            // Update profile menu with user information
            $('#userMenuName').text(userData.name || 'Michael Man');
            $('#userMenuEmail').text(userData.email || 'microb@example.com');
            $('#userMenuPhone').text(userData.phone || '092236789');
            $('#userMenuAddress').text(userData.address || 'Hanoi');
            
            // Update avatar with user's name
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.name || 'MM')}&background=4F46E5&color=fff`;
            $('#userAvatar').attr('src', avatarUrl);
            $('#userMenuAvatar').attr('src', avatarUrl);
        }

        // Add cancelBooking function
        function cancelBooking(bookingId) {
            ajaxWithAuth({
                url: `/booking/cancel/${bookingId}`,
                method: 'POST',
                success: function(response) {
                    console.log('Cancel booking response:', response);
                    
                    Swal.fire({
                        title: 'Cancelled!',
                        text: 'Your booking has been cancelled successfully.',
                        icon: 'success'
                    }).then(() => {
                        // Reload bookings
                        loadBookings();
                    });
                },
                error: function(xhr) {
                    console.error('Error cancelling booking:', xhr);
                    
                    let errorMessage = 'An error occurred while cancelling your booking. Please try again.';
                    
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    
                    Swal.fire({
                        title: 'Error',
                        text: errorMessage,
                        icon: 'error'
                    });
                }
            });
        }

        function handlePayment(bookingId) {
            // Get token
            const token = getCookie('token');
            
            if (!token) {
                Swal.fire({
                    title: 'Error',
                    text: 'Your session has expired. Please log in again.',
                    icon: 'error'
                }).then(() => {
                    window.location.href = '/login.html';
                });
                return;
            }

            // Prepare request data
            const requestData = {
                bookingId: bookingId
            };

            console.log('Creating booking bill for booking ID:', bookingId);
            
            // Show loading indicator
            Swal.fire({
                title: 'Creating Bill',
                text: 'Please wait while we prepare your bill...',
                icon: 'info',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Step 1: Create a bill
            $.ajax({
                url: '/bill/create',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify(requestData),
                success: function(response) {
                    console.log('Bill created successfully:', response);
                    
                    if (response && response.result) {
                        const billResponse = response.result;
                        const bookingBillId = billResponse.bookingBillId;
                        const amount = billResponse.grandTotal;
                        
                        // Show confirmation dialog
                        Swal.fire({
                            title: 'Proceed to Payment?',
                            html: `
                                <div class="text-left">
                                    <p>Your booking bill has been created with the following details:</p>
                                    <div class="mt-4 p-4 bg-gray-100 rounded-lg">
                                        <p><strong>Bill ID:</strong> ${bookingBillId}</p>
                                        <p><strong>Amount:</strong> ${formatCurrency(amount)} VND</p>
                                    </div>
                                    <p class="mt-4">Do you want to proceed with the payment via ZaloPay?</p>
                                </div>
                            `,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonColor: '#4F46E5',
                            cancelButtonColor: '#EF4444',
                            confirmButtonText: 'Yes, pay now',
                            cancelButtonText: 'No, cancel payment'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // User wants to proceed with the payment
                                createZaloPayOrder(bookingBillId);
                            } else {
                                // User wants to cancel the payment
                                deleteBookingBill(bookingBillId);
                            }
                        });
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: 'Failed to create bill. Please try again.',
                            icon: 'error'
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error creating bill:', xhr.responseText);
                    let errorMessage = 'An error occurred while creating the bill. Please try again.';
                    
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    
                    // Kiểm tra nếu lỗi là duplicate entry cho booking bill
                    if (xhr.responseText && xhr.responseText.includes('Duplicate entry') && xhr.responseText.includes('booking_bills')) {
                        errorMessage = 'A payment has already been initiated for this booking. Please check your pending payments or try again later.';
                        
                        Swal.fire({
                            title: 'Payment Already Initiated',
                            text: errorMessage,
                            icon: 'info',
                            confirmButtonColor: '#4F46E5',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            // Reload bookings to get updated status
                            loadBookings();
                        });
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: errorMessage,
                            icon: 'error'
                        });
                    }
                }
            });
        }

        function deleteBookingBill(bookingBillId) {
            const token = getCookie('token');
            
            // Show loading indicator
            Swal.fire({
                title: 'Cancelling Bill',
                text: 'Please wait while we cancel your bill...',
                icon: 'info',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Call API to delete the booking bill
            $.ajax({
                url: `/bill/delete/${bookingBillId}`,
                type: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                success: function(response) {
                    console.log('Bill deleted successfully:', response);
                    
                    Swal.fire({
                        title: 'Payment Cancelled',
                        text: 'Your bill has been cancelled successfully.',
                        icon: 'info'
                    }).then(() => {
                        // Reload the bookings to refresh the status
                        loadBookings();
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting bill:', xhr.responseText);
                    let errorMessage = 'An error occurred while cancelling the bill. Please try again.';
                    
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    
                    Swal.fire({
                        title: 'Error',
                        text: errorMessage,
                        icon: 'error'
                    });
                }
            });
        }

        function showZaloPayErrorDetails(errorCode, errorMessage) {
            let detailedMessage = errorMessage;
            
            // Provide more specific guidance based on error code
            switch(errorCode) {
                case 1015:
                    detailedMessage = "Payment creation failed! This error typically occurs when there is an issue with the ZaloPay configuration or connection. Please check:";
                    
                    Swal.fire({
                        title: 'ZaloPay Configuration Error',
                        html: `
                            <div class="text-left">
                                <p>${detailedMessage}</p>
                                <ul class="mt-4 space-y-2 text-sm">
                                    <li>• ZaloPay app ID, key1, and key2 in application.yaml</li>
                                    <li>• Callback URL configuration in ZaloPayConfig.java</li>
                                    <li>• Network connectivity to ZaloPay API servers</li>
                                    <li>• Possible sandbox/production mode mismatch</li>
                                </ul>
                                <p class="mt-4">Please contact customer support if the issue persists.</p>
                            </div>
                        `,
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#4F46E5'
                    });
                    break;
                    
                default:
                    Swal.fire({
                        title: 'Payment Error',
                        text: detailedMessage,
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#4F46E5'
                    });
            }
        }

        function createZaloPayOrder(bookingBillId) {
            const token = getCookie('token');
            
            // Check if there's an active internet connection
            if (!navigator.onLine) {
                Swal.fire({
                    title: 'No Internet Connection',
                    text: 'Please check your internet connection and try again.',
                    icon: 'warning',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#4F46E5'
                });
                return;
            }
            
            // Show loading indicator
            Swal.fire({
                title: 'Processing Payment',
                text: 'Please wait while we redirect you to the payment gateway...',
                icon: 'info',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Lưu bookingBillId vào cookie thay vì localStorage
            console.log('Creating ZaloPay order for bill ID:', bookingBillId);
            
            document.cookie = "currentBookingBillId=" + bookingBillId + "; path=/; max-age=1800; SameSite=Lax";
            
            // Prepare payment request data
            const requestData = {
                bookingBillId: bookingBillId  // ZaloPayOrderRequest uses bookingBillId field
            };
            
            console.log('Sending ZaloPay payment request:', requestData);
            
            // Debug note
            console.log('Debug: If payment fails with code 1015, check ZaloPay configuration in application.yaml file and ZaloPayConfig.java');
            
            $.ajax({
                url: '/zalopay/order',  // Updated endpoint
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify(requestData),
                success: function(response) {
                    console.log('ZaloPay order created successfully:', response);
                    
                    if (response && response.result) {
                        try {
                            // Parse JSON string response
                            const zaloPayResponse = JSON.parse(response.result);
                            console.log('Parsed ZaloPay response:', zaloPayResponse);
                            
                            if (zaloPayResponse.return_code === 1 && zaloPayResponse.order_url) {
                                // Redirect to ZaloPay payment page
                                window.open(zaloPayResponse.order_url, '_blank');
                                
                                Swal.fire({
                                    title: 'Payment Initiated',
                                    text: 'You have been redirected to ZaloPay. After completing payment, please return to this page to check your booking status.',
                                    icon: 'success'
                                }).then(() => {
                                    // Reload the bookings
                                    loadBookings();
                                });
                            } else if (zaloPayResponse.error) {
                                Swal.fire({
                                    title: 'Error',
                                    text: 'ZaloPay error: ' + zaloPayResponse.error,
                                    icon: 'error'
                                });
                            } else {
                                Swal.fire({
                                    title: 'Error',
                                    text: 'Failed to create payment order. Error code: ' + (zaloPayResponse.return_code || 'Unknown') + 
                                          ', Message: ' + (zaloPayResponse.return_message || ''),
                                    icon: 'error'
                                });
                            }
                        } catch (parseError) {
                            console.error('Error parsing ZaloPay response:', parseError);
                            Swal.fire({
                                title: 'Error',
                                text: 'Could not process ZaloPay response. Please try again.',
                                icon: 'error'
                            });
                        }
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: 'Failed to create payment order. Please try again.',
                            icon: 'error'
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error creating ZaloPay order:', xhr.responseText);
                    
                    // Log detailed information about the error
                    console.log({
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseText: xhr.responseText,
                        error: error
                    });
                    
                    let errorMessage = 'An error occurred while creating the payment order. Please try again.';
                    let errorCode = null;
                    
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                        errorCode = xhr.responseJSON.code;
                    } else if (xhr.responseText) {
                        try {
                            const errorObj = JSON.parse(xhr.responseText);
                            errorMessage = errorObj.message || errorMessage;
                            errorCode = errorObj.code;
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                        }
                    }
                    
                    // Show detailed error based on error code
                    showZaloPayErrorDetails(errorCode, errorMessage);
                }
            });
        }

        // Thêm hàm mới để xác nhận việc hủy đặt phòng với cảnh báo không hoàn tiền
        function cancelBookingWithConfirmation(bookingId) {
            if (!bookingId) {
                console.error('No booking ID provided');
                return;
            }

            // Show confirmation dialog with warning about no refund
            Swal.fire({
                title: 'Hủy đặt phòng?',
                html: `
                    <div class="text-left">
                        <p>Bạn có chắc chắn muốn hủy đặt phòng này?</p>
                        <div class="mt-4 p-4 bg-red-50 rounded-lg">
                            <p class="text-red-600 font-bold">Lưu ý quan trọng:</p>
                            <p class="text-red-600">Việc hủy đặt phòng sẽ không được hoàn tiền.</p>
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#EF4444',
                cancelButtonColor: '#6B7280',
                confirmButtonText: 'Đồng ý, hủy đặt phòng',
                cancelButtonText: 'Không, giữ lại'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Người dùng đã xác nhận, tiến hành hủy đặt phòng
                    cancelBooking(bookingId);
                }
            });
        }

        // Function to create bill
        async function createBill(bookingId) {
            try {
                // Show loading indicator
                Swal.fire({
                    title: 'Creating Bill',
                    text: 'Please wait while we create your bill...',
                    icon: 'info',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                const token = getCookie('token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }
                
                const response = await fetchWithAuth('https://localhost:8443/bill/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ bookingId }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to create bill');
                }

                if (data.result) {
                    // Show success message
                    Swal.fire({
                        title: 'Success!',
                        text: 'Bill created successfully!',
                        icon: 'success',
                        confirmButtonText: 'View Bills'
                    }).then(() => {
                        // Redirect to my-bills page
                        window.location.href = '/my-bills.html';
                    });
                } else {
                    throw new Error(data.message || 'Unknown error creating bill');
                }
            } catch (error) {
                console.error('Error creating bill:', error);
                
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to create bill. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        // Add function to display booking details
        async function displayBookingDetails(bookingId) {
            try {
                const token = getCookie('token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }

                // Lưu bookingId vào cookie thay vì localStorage
                document.cookie = "currentBookingId=" + bookingId + "; path=/; max-age=1800; SameSite=Lax";

                // Show loading indicator
                Swal.fire({
                    title: 'Loading Booking Details',
                    text: 'Please wait...',
                    icon: 'info',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const response = await fetchWithAuth(`https://localhost:8443/booking/info/${bookingId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const data = await response.json();
                console.log('Booking response:', data); // Debug log

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to fetch booking details');
                }

                if (data.result) {
                    const booking = data.result;
                    console.log('Booking rooms:', booking.bookingRooms); // Debug log
                    console.log('Booking items:', booking.bookingItems); // Debug log
                    
                    // Format the booking details for display
                    const detailsHtml = `
                        <div class="text-left">
                            <div class="mb-4">
                                <h3 class="text-lg font-bold text-gray-900 mb-2 flex items-center">
                                    <i class="fas fa-info-circle text-indigo-500 mr-2"></i>
                                    Booking Information
                                </h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-gray-600 flex items-center">
                                            <i class="fas fa-hashtag text-gray-400 mr-2"></i>
                                            Booking ID:
                                        </p>
                                        <p class="font-semibold">${booking.bookingId || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600 flex items-center">
                                            <i class="fas fa-user text-gray-400 mr-2"></i>
                                            Customer Name:
                                        </p>
                                        <p class="font-semibold">${booking.customerName || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600 flex items-center">
                                            <i class="fas fa-calendar text-gray-400 mr-2"></i>
                                            Booking Date:
                                        </p>
                                        <p class="font-semibold">${booking.bookingDate ? new Date(booking.bookingDate).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600 flex items-center">
                                            <i class="fas fa-clock text-gray-400 mr-2"></i>
                                            Booking Status:
                                        </p>
                                        <p class="font-semibold">${booking.bookingStatus || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600 flex items-center">
                                            <i class="fas fa-credit-card text-gray-400 mr-2"></i>
                                            Payment Status:
                                        </p>
                                        <p class="font-semibold">${booking.paymentStatus || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h3 class="text-lg font-bold text-gray-900 mb-2 flex items-center">
                                    <i class="fas fa-bed text-indigo-500 mr-2"></i>
                                    Room Details
                                </h3>
                                <div class="space-y-2">
                                    ${Array.isArray(booking.bookingRooms) && booking.bookingRooms.length > 0 ? 
                                        booking.bookingRooms.map(room => {
                                            console.log('Processing room:', room);
                                            return `
                                                <div class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                                                    <p class="font-semibold flex items-center">
                                                        <i class="fas fa-door-open text-indigo-500 mr-2"></i>
                                                        Room ${room.rooms?.[0] || 'N/A'}
                                                    </p>
                                                    <p class="text-gray-600 flex items-center">
                                                        <i class="fas fa-sign-in-alt text-gray-400 mr-2"></i>
                                                        Check-in: ${room.checkInDate ? new Date(room.checkInDate[0], room.checkInDate[1]-1, room.checkInDate[2]).toLocaleDateString('vi-VN') : 'N/A'}
                                                    </p>
                                                    <p class="text-gray-600 flex items-center">
                                                        <i class="fas fa-sign-out-alt text-gray-400 mr-2"></i>
                                                        Check-out: ${room.checkOutDate ? new Date(room.checkOutDate[0], room.checkOutDate[1]-1, room.checkOutDate[2]).toLocaleDateString('vi-VN') : 'N/A'}
                                                    </p>
                                                    <p class="text-gray-600 flex items-center">
                                                        <i class="fas fa-money-bill-wave text-gray-400 mr-2"></i>
                                                        Amount: ${room.totalRoomAmount ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(room.totalRoomAmount) : 'N/A'}
                                                    </p>
                                                </div>
                                            `;
                                        }).join('') : 
                                        '<p class="text-gray-500 italic">No room details available</p>'
                                    }
                                </div>
                            </div>

                            <div class="mb-4">
                                <h3 class="text-lg font-bold text-gray-900 mb-2 flex items-center">
                                    <i class="fas fa-concierge-bell text-indigo-500 mr-2"></i>
                                    Service Details
                                </h3>
                                <div class="space-y-2">
                                    ${Array.isArray(booking.bookingItems) && booking.bookingItems.length > 0 ? 
                                        booking.bookingItems.map(item => {
                                            console.log('Processing item:', item);
                                            return `
                                                <div class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                                                    <p class="font-semibold flex items-center">
                                                        <i class="fas fa-utensils text-indigo-500 mr-2"></i>
                                                        ${item.hotelOffer || 'N/A'}
                                                    </p>
                                                    <p class="text-gray-600 flex items-center">
                                                        <i class="fas fa-hashtag text-gray-400 mr-2"></i>
                                                        Quantity: ${item.quantity || 'N/A'}
                                                    </p>
                                                    <p class="text-gray-600 flex items-center">
                                                        <i class="fas fa-money-bill-wave text-gray-400 mr-2"></i>
                                                        Price: ${item.totalItemsPrice ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.totalItemsPrice) : 'N/A'}
                                                    </p>
                                                </div>
                                            `;
                                        }).join('') : 
                                        '<p class="text-gray-500 italic">No service details available</p>'
                                    }
                                </div>
                            </div>

                            <div class="mt-4 p-4 bg-indigo-50 rounded-lg">
                                <h3 class="text-lg font-bold text-indigo-900 mb-2 flex items-center">
                                    <i class="fas fa-calculator text-indigo-500 mr-2"></i>
                                    Payment Summary
                                </h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-gray-600 flex items-center">
                                            <i class="fas fa-bed text-gray-400 mr-2"></i>
                                            Room Total:
                                        </p>
                                        <p class="font-semibold">${booking.totalRoomPrice ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(booking.totalRoomPrice) : 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600 flex items-center">
                                            <i class="fas fa-concierge-bell text-gray-400 mr-2"></i>
                                            Services Total:
                                        </p>
                                        <p class="font-semibold">${booking.totalBookingServicePrice ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(booking.totalBookingServicePrice) : 'N/A'}</p>
                                    </div>
                                    <div class="col-span-2">
                                        <p class="text-gray-600 flex items-center">
                                            <i class="fas fa-money-bill-wave text-gray-400 mr-2"></i>
                                            Grand Total:
                                        </p>
                                        <p class="text-xl font-bold text-indigo-600">${booking.grandTotal ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(booking.grandTotal) : 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Show the details in a modal
                    const modal = Swal.fire({
                        title: 'Booking Details',
                        html: detailsHtml,
                        showCloseButton: true,
                        showConfirmButton: false,
                        allowOutsideClick: true,
                        allowEscapeKey: true,
                        customClass: {
                            container: 'booking-details-modal',
                            popup: 'max-h-[85vh] overflow-y-auto'
                        },
                        didOpen: () => {
                            // Add animation to elements
                            const elements = document.querySelectorAll('.booking-details-modal .p-3, .booking-details-modal .p-4');
                            elements.forEach((el, index) => {
                                el.style.opacity = '0';
                                el.style.transform = 'translateY(20px)';
                                setTimeout(() => {
                                    el.style.transition = 'all 0.3s ease';
                                    el.style.opacity = '1';
                                    el.style.transform = 'translateY(0)';
                                }, index * 100);
                            });
                        },
                        willClose: () => {
                            // Add closing animation
                            const elements = document.querySelectorAll('.booking-details-modal .p-3, .booking-details-modal .p-4');
                            elements.forEach((el, index) => {
                                el.style.transition = 'all 0.2s ease';
                                el.style.opacity = '0';
                                el.style.transform = 'translateY(-20px)';
                            });
                        }
                    });

                    // Handle close button click
                    document.querySelector('.swal2-close').addEventListener('click', () => {
                        // Remove modal and backdrop
                        const modalElement = document.querySelector('.swal2-container');
                        const backdropElement = document.querySelector('.swal2-backdrop-show');
                        
                        if (modalElement) {
                            modalElement.style.opacity = '0';
                            modalElement.style.transition = 'opacity 0.2s ease';
                        }
                        
                        if (backdropElement) {
                            backdropElement.style.opacity = '0';
                            backdropElement.style.transition = 'opacity 0.2s ease';
                        }
                        
                        // Remove elements after animation
                        setTimeout(() => {
                            if (modalElement) modalElement.remove();
                            if (backdropElement) backdropElement.remove();
                            // Remove any remaining modal classes from body
                            document.body.classList.remove('swal2-shown', 'swal2-height-auto');
                        }, 200);
                    });

                    // Handle outside click
                    document.querySelector('.swal2-backdrop-show')?.addEventListener('click', (e) => {
                        if (e.target.classList.contains('swal2-backdrop-show')) {
                            const modalElement = document.querySelector('.swal2-container');
                            const backdropElement = document.querySelector('.swal2-backdrop-show');
                            
                            if (modalElement) {
                                modalElement.style.opacity = '0';
                                modalElement.style.transition = 'opacity 0.2s ease';
                            }
                            
                            if (backdropElement) {
                                backdropElement.style.opacity = '0';
                                backdropElement.style.transition = 'opacity 0.2s ease';
                            }
                            
                            setTimeout(() => {
                                if (modalElement) modalElement.remove();
                                if (backdropElement) backdropElement.remove();
                                document.body.classList.remove('swal2-shown', 'swal2-height-auto');
                            }, 200);
                        }
                    });
                } else {
                    throw new Error('No booking details found');
                }
            } catch (error) {
                console.error('Error displaying booking details:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to load booking details',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }
    </script>
</body>
</html> 